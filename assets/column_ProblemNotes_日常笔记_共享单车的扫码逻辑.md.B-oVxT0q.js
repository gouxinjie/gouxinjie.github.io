import{_ as B,C as t,c as e,o,j as r,G as A,a2 as l,b as g,a as n,w as s,a7 as C}from"./chunks/framework.DrNAj9nU.js";const m=JSON.parse('{"title":"共享单车的扫码开锁逻辑","description":"","frontmatter":{},"headers":[],"relativePath":"column/ProblemNotes/日常笔记/共享单车的扫码逻辑.md","filePath":"column/ProblemNotes/日常笔记/共享单车的扫码逻辑.md","lastUpdated":1768463848000}'),p={name:"column/ProblemNotes/日常笔记/共享单车的扫码逻辑.md"};function u(d,E,h,_,c,D){const a=t("ArticleMetadata"),i=t("Mermaid");return o(),e("div",null,[E[1]||(E[1]=r("h1",{id:"共享单车的扫码开锁逻辑",tabindex:"-1"},[n("共享单车的扫码开锁逻辑 "),r("a",{class:"header-anchor",href:"#共享单车的扫码开锁逻辑","aria-label":'Permalink to "共享单车的扫码开锁逻辑"'},"​")],-1)),A(a),E[2]||(E[2]=l('<nav class="table-of-contents"><ul><li><a href="#第一阶段-扫码识别与开锁请求-用户发起">第一阶段：扫码识别与开锁请求 (用户发起)</a></li><li><a href="#第二阶段-服务器校验与指令生成-云端决策">第二阶段：服务器校验与指令生成 (云端决策)</a></li><li><a href="#第三阶段-指令下达与物理开锁-车锁执行">第三阶段：指令下达与物理开锁 (车锁执行)</a></li><li><a href="#第四阶段-结束骑行与关锁结算-流程闭环">第四阶段：结束骑行与关锁结算 (流程闭环)</a></li><li><a href="#关键技术要点与安全设计">关键技术要点与安全设计</a></li><li><a href="#总结">总结</a></li></ul></nav><p>共享单车的扫码开锁逻辑是一个非常经典的<strong>物联网（IoT）应用实例</strong>，它结合了移动互联网、嵌入式系统和后端服务。与普通扫码登录相比，它多了对<strong>物理硬件（智能锁）的控制</strong>环节。</p><p>其核心原理是：<strong>手机 App 通过扫描单车二维码，获取单车唯一身份标识，然后请求云端服务器向该单车发送开锁指令。</strong></p><p>下图清晰地展示了从用户扫码到锁开的完整流程与数据交互：</p>',4)),(o(),g(C,null,{default:s(()=>[A(i,{id:"mermaid-15",class:"mermaid",graph:"sequenceDiagram%0A%20%20%20%20participant%20U%20as%20%E7%94%A8%E6%88%B7%E6%89%8B%E6%9C%BAApp%0A%20%20%20%20participant%20S%20as%20%E4%BA%91%E7%AB%AF%E6%9C%8D%E5%8A%A1%E5%99%A8%0A%20%20%20%20participant%20B%20as%20%E5%85%B1%E4%BA%AB%E5%8D%95%E8%BD%A6%E6%99%BA%E8%83%BD%E9%94%81%0A%0A%20%20%20%20Note%20over%20U%2CB%3A%20%E7%AC%AC%E4%B8%80%E6%AD%A5%EF%BC%9A%E6%89%AB%E7%A0%81%E8%AF%86%E5%88%AB%E4%B8%8E%E8%AF%B7%E6%B1%82%0A%20%20%20%20U-%3E%3EB%3A%201.%20%E6%89%AB%E6%8F%8F%E8%BD%A6%E8%BA%AB%E4%BA%8C%E7%BB%B4%E7%A0%81%2F%E8%BE%93%E5%85%A5%E7%BC%96%E5%8F%B7%0A%20%20%20%20U-%3E%3ES%3A%202.%20%E5%8F%91%E9%80%81%E6%89%AB%E7%A0%81%E4%BF%A1%E6%81%AF%20%2B%20%E7%94%A8%E6%88%B7%E8%BA%AB%E4%BB%BDToken%20%2B%20%E8%BD%A6%E8%BE%86%E4%BD%8D%E7%BD%AE%0A%0A%20%20%20%20Note%20over%20S%3A%20%E7%AC%AC%E4%BA%8C%E6%AD%A5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%A0%A1%E9%AA%8C%E4%B8%8E%E6%8C%87%E4%BB%A4%E7%94%9F%E6%88%90%0A%20%20%20%20S-%3E%3ES%3A%203.%20%E6%A0%A1%E9%AA%8C%E7%94%A8%E6%88%B7%E3%80%81%E8%BD%A6%E8%BE%86%E7%8A%B6%E6%80%81%E3%80%81%E8%AE%A1%E8%B4%B9%E8%A7%84%E5%88%99%0A%20%20%20%20S-%3E%3ES%3A%204.%20%E7%94%9F%E6%88%90%E5%BC%80%E9%94%81%E6%8C%87%E4%BB%A4%EF%BC%8C%E5%85%B3%E8%81%94%E8%AE%A2%E5%8D%95%EF%BC%8C%E5%BC%80%E5%A7%8B%E8%AE%A1%E8%B4%B9%0A%0A%20%20%20%20Note%20over%20S%2CB%3A%20%E7%AC%AC%E4%B8%89%E6%AD%A5%EF%BC%9A%E6%8C%87%E4%BB%A4%E4%B8%8B%E8%BE%BE%E4%B8%8E%E8%A7%A3%E9%94%81%0A%20%20%20%20S-%3E%3EB%3A%205.%20%E9%80%9A%E8%BF%87%E7%BD%91%E7%BB%9C%E4%B8%8B%E5%8F%91%E5%BC%80%E9%94%81%E6%8C%87%E4%BB%A4%0A%20%20%20%20B-%3E%3EB%3A%206.%20%E9%AA%8C%E8%AF%81%E6%8C%87%E4%BB%A4%EF%BC%8C%E9%A9%B1%E5%8A%A8%E7%94%B5%E6%9C%BA%E5%BC%80%E9%94%81%0A%20%20%20%20B-%3E%3ES%3A%207.%20%E4%B8%8A%E6%8A%A5%E2%80%9C%E5%BC%80%E9%94%81%E6%88%90%E5%8A%9F%E2%80%9D%E7%8A%B6%E6%80%81%0A%20%20%20%20S-%3E%3EU%3A%208.%20%E6%8E%A8%E9%80%81%E5%BC%80%E9%94%81%E6%88%90%E5%8A%9F%E9%80%9A%E7%9F%A5%EF%BC%8CApp%E6%98%BE%E7%A4%BA%E2%80%9C%E5%BC%80%E9%94%81%E6%88%90%E5%8A%9F%E2%80%9D%0A%0A%20%20%20%20Note%20over%20U%2CB%3A%20%E7%AC%AC%E5%9B%9B%E6%AD%A5%EF%BC%9A%E9%AA%91%E8%A1%8C%E4%B8%8E%E5%85%B3%E9%94%81%E7%BB%93%E7%AE%97%0A%20%20%20%20B-%3E%3ES%3A%209.%20%E9%94%81%E8%BD%A6%E7%89%A9%E7%90%86%E8%A7%A6%E5%8F%91%EF%BC%8C%E4%B8%8A%E6%8A%A5%E2%80%9C%E5%85%B3%E9%94%81%E2%80%9D%2B%E4%BD%8D%E7%BD%AE%0A%20%20%20%20S-%3E%3ES%3A%2010.%20%E5%81%9C%E6%AD%A2%E8%AE%A1%E8%B4%B9%EF%BC%8C%E7%94%9F%E6%88%90%E8%AE%A2%E5%8D%95%0A%20%20%20%20S-%3E%3EU%3A%2011.%20%E6%8E%A8%E9%80%81%E8%A1%8C%E7%A8%8B%E7%BB%93%E6%9D%9F%E9%80%9A%E7%9F%A5%E5%92%8C%E8%B4%A6%E5%8D%95%0A"})]),fallback:s(()=>[...E[0]||(E[0]=[n(" Loading... ",-1)])]),_:1})),E[3]||(E[3]=l('<hr><p>下面我们来详细拆解图中的每一个阶段和关键技术点：</p><h3 id="第一阶段-扫码识别与开锁请求-用户发起" tabindex="-1">第一阶段：扫码识别与开锁请求 (用户发起) <a class="header-anchor" href="#第一阶段-扫码识别与开锁请求-用户发起" aria-label="Permalink to &quot;第一阶段：扫码识别与开锁请求 (用户发起)&quot;">​</a></h3><ol><li><strong>二维码内容</strong>：单车上印刷的<strong>二维码（或输入编号）</strong>，本质上是这辆单车的<strong>全球唯一编号（Vehicle ID）</strong> 和一个简短的服务器地址。它<strong>不包含开锁密码或指令本身</strong>。</li><li><strong>App 动作</strong>：你打开 App 扫码后，App 会： <ul><li>解析出车辆 ID。</li><li>将 <strong>车辆 ID + 你的用户身份 Token（代表已登录账户）+ 当前手机 GPS 定位</strong> 打包，通过蜂窝网络（4G/5G）发送到<strong>云端服务器</strong>。</li></ul></li></ol><h3 id="第二阶段-服务器校验与指令生成-云端决策" tabindex="-1">第二阶段：服务器校验与指令生成 (云端决策) <a class="header-anchor" href="#第二阶段-服务器校验与指令生成-云端决策" aria-label="Permalink to &quot;第二阶段：服务器校验与指令生成 (云端决策)&quot;">​</a></h3><p>这是<strong>最核心的业务逻辑处理层</strong>，所有安全和计费规则都在这里。</p><ol start="3"><li><strong>身份与状态校验</strong>： <ul><li><strong>用户校验</strong>：账户是否有效、有无欠费、信用分是否足够。</li><li><strong>车辆校验</strong>：这辆车 ID 是否存在、是否已被预约或骑行、是否报修、是否在可运营区域（电子围栏）。</li><li><strong>位置校验</strong>：手机 GPS 位置与车辆上报的最近位置是否在合理范围内（防远程开锁）。</li></ul></li><li><strong>业务处理</strong>：校验通过后，服务器： <ul><li><strong>创建一条骑行订单</strong>，状态为“开锁中”，开始计时（或准备开始）。</li><li><strong>生成一个一次性的、有时效的“开锁指令”</strong>。这个指令通常是动态密钥，包含车辆 ID、指令序列号、时间戳等信息，并经过加密。</li></ul></li></ol><h3 id="第三阶段-指令下达与物理开锁-车锁执行" tabindex="-1">第三阶段：指令下达与物理开锁 (车锁执行) <a class="header-anchor" href="#第三阶段-指令下达与物理开锁-车锁执行" aria-label="Permalink to &quot;第三阶段：指令下达与物理开锁 (车锁执行)&quot;">​</a></h3><ol start="5"><li><strong>通信链路</strong>：服务器通过<strong>移动网络（内置的 SIM 卡，通常是 2G/NB-IoT）</strong> 将开锁指令下发到目标单车的<strong>通信模块（MCU）</strong>。</li><li><strong>锁端验证</strong>：单车的智能锁主控芯片接收到指令后，会进行本地验证（如校验指令格式、时效性、是否重复等）。</li><li><strong>执行开锁</strong>：验证通过后，主控芯片<strong>控制电机或电磁铁</strong>，驱动机械锁舌收回，完成开锁。 <ul><li><strong>“开锁成功”信号反馈</strong>：锁内的传感器（如霍尔传感器）检测到锁舌状态变化，会通过通信模块向服务器上报“开锁成功”状态。</li></ul></li><li><strong>用户感知</strong>：服务器收到锁端成功反馈后，立即通过<strong>推送服务</strong>通知你的手机 App：“开锁成功，可以骑行了”。</li></ol><h3 id="第四阶段-结束骑行与关锁结算-流程闭环" tabindex="-1">第四阶段：结束骑行与关锁结算 (流程闭环) <a class="header-anchor" href="#第四阶段-结束骑行与关锁结算-流程闭环" aria-label="Permalink to &quot;第四阶段：结束骑行与关锁结算 (流程闭环)&quot;">​</a></h3><ol start="9"><li><strong>关锁触发</strong>：骑行结束后，你手动合上锁栓（机械动作）。 <ul><li>锁栓合上的瞬间，会触发一个<strong>物理开关</strong>。</li><li>智能锁检测到关锁信号，立即通过移动网络向服务器发送“<strong>关锁结束</strong>”报文，并<strong>附上关锁时的大致位置</strong>（基于基站定位或最后通信位置）。</li></ul></li><li><strong>订单结算</strong>：服务器收到关锁信号后： <ul><li>将对应订单状态更新为“已完成”。</li><li><strong>停止计时计费</strong>。</li><li>根据骑行时长、套餐规则等，生成最终账单，并从你的账户扣费（或生成待支付订单）。</li><li>更新车辆状态为“可用”。</li></ul></li><li><strong>推送账单</strong>：手机 App 立刻收到行程结束通知和费用明细。</li></ol><hr><h3 id="关键技术要点与安全设计" tabindex="-1">关键技术要点与安全设计 <a class="header-anchor" href="#关键技术要点与安全设计" aria-label="Permalink to &quot;关键技术要点与安全设计&quot;">​</a></h3><ol><li><strong>低功耗广域网通信（LPWAN）</strong>： <ul><li>车辆锁内置的是 <strong>NB-IoT 或 2G 模块</strong>，而非 Wi-Fi 或蓝牙。因为它们需要<strong>广域、低功耗、长待机</strong>（单车可能几周才被骑一次），NB-IoT 是主流选择。</li></ul></li><li><strong>开锁指令的动态性</strong>： <ul><li>每次开锁指令都是<strong>云端动态生成、一次性有效</strong>的，即使被截获也无法重复使用。</li></ul></li><li><strong>离线机制（容灾设计）</strong>： <ul><li>在信号极差的地方，开锁流程可能卡住。有些设计是：服务器下发一个离线密码（一串数字）到 App，用户在锁上小键盘输入该密码开锁。密码同样有时效性。</li></ul></li><li><strong>蓝牙辅助开锁</strong>： <ul><li>为了提升开锁速度和成功率，许多单车增加了<strong>蓝牙</strong>模块。流程变为：App 通过蓝牙与附近的单车快速连接，然后将云端指令通过蓝牙通道转发给单车，再由单车用其移动网络与云端做最终确认。这样速度快，且更省电（蓝牙功耗远低于移动网络通信）。</li></ul></li><li><strong>状态心跳</strong>： <ul><li>单车会定期（如每几小时）向服务器发送“心跳包”，报告位置（粗略基站定位）、电量、锁状态等，便于运维管理。</li></ul></li></ol><h3 id="总结" tabindex="-1">总结 <a class="header-anchor" href="#总结" aria-label="Permalink to &quot;总结&quot;">​</a></h3><p>共享单车的扫码开锁是一个 <strong>“云端决策，锁端执行”</strong> 的强控制流程。<strong>二维码只是一个启动按钮和身份识别器</strong>，真正的智能和安全控制都在云端。这个设计保证了：</p><ul><li><strong>集中控制</strong>：所有开锁、计费、状态管理由云端统一处理，逻辑清晰。</li><li><strong>安全可靠</strong>：开锁指令动态下发，锁端有基本验证。</li><li><strong>可运营</strong>：可以随时在后台禁用某辆车、调整计费规则、查看车辆分布。</li></ul><p>它与“扫码登录”最大的区别在于，<strong>多了对物理硬件的远程控制和安全、实时的状态同步需求</strong>，是一个典型的物联网系统。</p>',18))])}const S=B(p,[["render",u]]);export{m as __pageData,S as default};
