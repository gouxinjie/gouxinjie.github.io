import{_ as n,C as l,c as p,o as h,j as i,G as e,a2 as t,a as k}from"./chunks/framework.DrNAj9nU.js";const r="/assets/auth-1.BN1pjLR9.png",b=JSON.parse('{"title":"å¸¸è§é‰´æƒæ–¹æ¡ˆ","description":"","frontmatter":{},"headers":[],"relativePath":"column/Next/è¿›é˜¶/å¸¸è§é‰´æƒæ–¹æ¡ˆ.md","filePath":"column/Next/è¿›é˜¶/å¸¸è§é‰´æƒæ–¹æ¡ˆ.md","lastUpdated":1768983294000}'),E={name:"column/Next/è¿›é˜¶/å¸¸è§é‰´æƒæ–¹æ¡ˆ.md"};function d(g,s,o,y,c,F){const a=l("ArticleMetadata");return h(),p("div",null,[s[0]||(s[0]=i("h1",{id:"å¸¸è§é‰´æƒæ–¹æ¡ˆ",tabindex:"-1"},[k("å¸¸è§é‰´æƒæ–¹æ¡ˆ "),i("a",{class:"header-anchor",href:"#å¸¸è§é‰´æƒæ–¹æ¡ˆ","aria-label":'Permalink to "å¸¸è§é‰´æƒæ–¹æ¡ˆ"'},"â€‹")],-1)),e(a),s[1]||(s[1]=t(`<nav class="table-of-contents"><ul><li><a href="#ä¸€ã€ğŸ”‘-å¸¸è§é‰´æƒæ–¹æ¡ˆ">ä¸€ã€ğŸ”‘ å¸¸è§é‰´æƒæ–¹æ¡ˆ</a><ul><li><a href="#_1-åŸºäº-cookie-session-æ¨èç”¨äºç½‘ç«™ç™»å½•">1. åŸºäº Cookie / Sessionï¼ˆæ¨èç”¨äºç½‘ç«™ç™»å½•ï¼‰</a></li><li><a href="#_2-åŸºäº-jwt-é€‚åˆå‰åç«¯åˆ†ç¦»-ç§»åŠ¨ç«¯-api-æœåŠ¡">2. åŸºäº JWTï¼ˆé€‚åˆå‰åç«¯åˆ†ç¦» / ç§»åŠ¨ç«¯ / API æœåŠ¡ï¼‰</a></li><li><a href="#_3-api-key-é€‚åˆæœåŠ¡ç«¯-api-è°ƒç”¨-æ¯”å¦‚-ai-æ¨¡å‹æ¥å£">3. API Keyï¼ˆé€‚åˆæœåŠ¡ç«¯ API è°ƒç”¨ï¼Œæ¯”å¦‚ AI æ¨¡å‹æ¥å£ï¼‰</a></li></ul></li><li><a href="#äºŒã€åŸºäºjwtè®¤è¯çš„æ¡ˆä¾‹">äºŒã€åŸºäºJWTè®¤è¯çš„æ¡ˆä¾‹</a><ul><li><a href="#_1-å®‰è£…ä¾èµ–">1. å®‰è£…ä¾èµ–</a></li><li><a href="#_2-æ·»åŠ ç™»å½•æ¥å£-app-api-auth-login-route-js">2. æ·»åŠ ç™»å½•æ¥å£ app/api/auth/login/route.js</a></li><li><a href="#_3-ä¿æŠ¤-api-users">3. ä¿æŠ¤ /api/users</a></li></ul></li></ul></nav><h2 id="ä¸€ã€ğŸ”‘-å¸¸è§é‰´æƒæ–¹æ¡ˆ" tabindex="-1">ä¸€ã€ğŸ”‘ å¸¸è§é‰´æƒæ–¹æ¡ˆ <a class="header-anchor" href="#ä¸€ã€ğŸ”‘-å¸¸è§é‰´æƒæ–¹æ¡ˆ" aria-label="Permalink to &quot;ä¸€ã€ğŸ”‘ å¸¸è§é‰´æƒæ–¹æ¡ˆ&quot;">â€‹</a></h2><p>åœ¨ <code>Next.js (App Router) </code>é‡Œï¼Œå¸¸è§çš„é‰´æƒæ–¹å¼æœ‰ä¸‰ç±»ï¼š</p><h3 id="_1-åŸºäº-cookie-session-æ¨èç”¨äºç½‘ç«™ç™»å½•" tabindex="-1">1. åŸºäº Cookie / Sessionï¼ˆæ¨èç”¨äºç½‘ç«™ç™»å½•ï¼‰ <a class="header-anchor" href="#_1-åŸºäº-cookie-session-æ¨èç”¨äºç½‘ç«™ç™»å½•" aria-label="Permalink to &quot;1. åŸºäº Cookie / Sessionï¼ˆæ¨èç”¨äºç½‘ç«™ç™»å½•ï¼‰&quot;">â€‹</a></h3><ul><li>ç”¨æˆ·ç™»å½•æ—¶ï¼ŒéªŒè¯ç”¨æˆ·å/å¯†ç  â†’ ç”Ÿæˆ Sessionï¼Œå†™åˆ°æ•°æ®åº“ï¼ˆæˆ– Redisï¼‰ã€‚</li><li>é€šè¿‡ <code>Set-Cookie</code> è¿”å›ç»™æµè§ˆå™¨ã€‚</li><li>åç»­è¯·æ±‚æ—¶ï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨å¸¦ä¸Š Cookieï¼ŒAPI è·¯ç”±é‡Œè§£æ Cookie å¹¶æ ¡éªŒã€‚</li></ul><p>ğŸ‘‰ å·¥å…·ï¼š</p><ul><li><a href="https://next-auth.js.org/" target="_blank" rel="noreferrer"><code>next-auth</code></a>ï¼ˆæœ€å¸¸è§ï¼Œæ”¯æŒ OAuthã€é‚®ç®±ç™»å½•ã€JWT ç­‰ï¼‰</li><li>è‡ªå·±å®ç°ï¼ˆç”¨ <code>cookies()</code> API + MySQL å­˜ Sessionï¼‰</li></ul><h3 id="_2-åŸºäº-jwt-é€‚åˆå‰åç«¯åˆ†ç¦»-ç§»åŠ¨ç«¯-api-æœåŠ¡" tabindex="-1">2. åŸºäº JWTï¼ˆé€‚åˆå‰åç«¯åˆ†ç¦» / ç§»åŠ¨ç«¯ / API æœåŠ¡ï¼‰ <a class="header-anchor" href="#_2-åŸºäº-jwt-é€‚åˆå‰åç«¯åˆ†ç¦»-ç§»åŠ¨ç«¯-api-æœåŠ¡" aria-label="Permalink to &quot;2. åŸºäº JWTï¼ˆé€‚åˆå‰åç«¯åˆ†ç¦» / ç§»åŠ¨ç«¯ / API æœåŠ¡ï¼‰&quot;">â€‹</a></h3><ul><li><p>ç™»å½•æ—¶ç”Ÿæˆ <strong>JWT Token</strong>ï¼ˆåŒ…å«ç”¨æˆ· ID ç­‰ä¿¡æ¯ï¼Œç­¾åä¿è¯ä¸è¢«ç¯¡æ”¹ï¼‰ã€‚</p></li><li><p>å®¢æˆ·ç«¯ä¿å­˜åˆ° <code>localStorage</code> æˆ– <code>httpOnly Cookie</code>ã€‚</p></li><li><p>æ¯æ¬¡è¯·æ±‚æ—¶åœ¨ <code>Authorization</code> å¤´é‡Œå¸¦ä¸Šï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>Authorization: Bearer &lt;token&gt;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div></li><li><p>API è·¯ç”±é‡Œæ ¡éªŒ Token æ˜¯å¦æœ‰æ•ˆã€‚</p></li></ul><p>ğŸ‘‰ å·¥å…·ï¼š</p><ul><li><code>jsonwebtoken</code> åº“</li><li>å¯ä»¥é…åˆ <code>middleware.js</code> åœ¨å…¨å±€åšä¿æŠ¤</li></ul><h3 id="_3-api-key-é€‚åˆæœåŠ¡ç«¯-api-è°ƒç”¨-æ¯”å¦‚-ai-æ¨¡å‹æ¥å£" tabindex="-1">3. API Keyï¼ˆé€‚åˆæœåŠ¡ç«¯ API è°ƒç”¨ï¼Œæ¯”å¦‚ AI æ¨¡å‹æ¥å£ï¼‰ <a class="header-anchor" href="#_3-api-key-é€‚åˆæœåŠ¡ç«¯-api-è°ƒç”¨-æ¯”å¦‚-ai-æ¨¡å‹æ¥å£" aria-label="Permalink to &quot;3. API Keyï¼ˆé€‚åˆæœåŠ¡ç«¯ API è°ƒç”¨ï¼Œæ¯”å¦‚ AI æ¨¡å‹æ¥å£ï¼‰&quot;">â€‹</a></h3><ul><li><p>ç»™æ¯ä¸ªç”¨æˆ·åˆ†é…ä¸€ä¸ª API Keyï¼ˆå­˜ MySQLï¼‰ã€‚</p></li><li><p>å®¢æˆ·ç«¯è¯·æ±‚æ—¶å¸¦ä¸Šï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>Authorization: Bearer &lt;API_KEY&gt;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div></li><li><p>åç«¯æ ¡éªŒ Key æ˜¯å¦å­˜åœ¨ &amp; æƒé™æ˜¯å¦è¶³å¤Ÿã€‚</p></li></ul><h2 id="äºŒã€åŸºäºjwtè®¤è¯çš„æ¡ˆä¾‹" tabindex="-1">äºŒã€åŸºäºJWTè®¤è¯çš„æ¡ˆä¾‹ <a class="header-anchor" href="#äºŒã€åŸºäºjwtè®¤è¯çš„æ¡ˆä¾‹" aria-label="Permalink to &quot;äºŒã€åŸºäºJWTè®¤è¯çš„æ¡ˆä¾‹&quot;">â€‹</a></h2><p>ä¸‹é¢æ˜¯ä¸€ä¸ªåœ¨ <code>Next.js</code>é¡¹ç›®ä¸­åŸºäº <code>JWT</code> ä¿æŠ¤ <code>/api/users</code> æ¥å£çš„æ¡ˆä¾‹ã€‚</p><h3 id="_1-å®‰è£…ä¾èµ–" tabindex="-1">1. å®‰è£…ä¾èµ– <a class="header-anchor" href="#_1-å®‰è£…ä¾èµ–" aria-label="Permalink to &quot;1. å®‰è£…ä¾èµ–&quot;">â€‹</a></h3><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pnpm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> jsonwebtoken</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bcryptjs</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h3 id="_2-æ·»åŠ ç™»å½•æ¥å£-app-api-auth-login-route-js" tabindex="-1">2. æ·»åŠ ç™»å½•æ¥å£ <code>app/api/auth/login/route.js</code> <a class="header-anchor" href="#_2-æ·»åŠ ç™»å½•æ¥å£-app-api-auth-login-route-js" aria-label="Permalink to &quot;2. æ·»åŠ ç™»å½•æ¥å£ \`app/api/auth/login/route.js\`&quot;">â€‹</a></h3><div class="language-js vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pool </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;@/lib/db&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> jwt </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;jsonwebtoken&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bcrypt </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;bcryptjs&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> SECRET</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> process.env.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">JWT_SECRET</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ||</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;mysecret&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// åº”æ”¾åˆ° .env æ–‡ä»¶</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> POST</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">req</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">email</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">password</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> req.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">json</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">rows</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pool.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">query</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;SELECT * FROM users WHERE email = ?&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, [email]);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (rows.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">length</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ===</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Response</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">stringify</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ error: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;ç”¨æˆ·ä¸å­˜åœ¨&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }), { status: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">401</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> user</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> rows[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> valid</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bcrypt.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">compare</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(password, user.password);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">valid) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Response</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">stringify</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ error: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;å¯†ç é”™è¯¯&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }), { status: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">401</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // ç”Ÿæˆ JWT</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> token</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> jwt.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sign</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ id: user.id, email: user.email }, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">SECRET</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, { expiresIn: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;1h&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> });</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Response</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">stringify</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ token }), {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      status: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">200</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      headers: { </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Content-Type&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;application/json&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (error) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Response</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">stringify</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ error: error.message }), { status: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">500</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>è°ƒç”¨ä¹‹åï¼Œè¿”å›çš„ <code>token</code> æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œç±»ä¼¼ <code>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MSwiZW1haWwiOiJ0ZXN0QHRlc3QuY29tIiwiaWF0IjoxNzI2NjY3NjQyLCJleHAiOjE3MjY2NzE2NDN9.1234567890abcdef1234567890abcdef</code>ã€‚</p><p><strong>å¦‚å›¾æ‰€ç¤ºï¼š</strong></p><p><img src="`+r+`" alt="auth-1.png" loading="lazy"></p><h3 id="_3-ä¿æŠ¤-api-users" tabindex="-1">3. ä¿æŠ¤ <code>/api/users</code> <a class="header-anchor" href="#_3-ä¿æŠ¤-api-users" aria-label="Permalink to &quot;3. ä¿æŠ¤ \`/api/users\`&quot;">â€‹</a></h3><p>åœ¨ <code>app/api/users/route.js</code> é‡ŒåŠ  <strong>Token æ ¡éªŒ</strong>ï¼š</p><div class="language-js vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pool </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;@/lib/db&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> jwt </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;jsonwebtoken&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> SECRET</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> process.env.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">JWT_SECRET</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ||</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;mysecret&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// æ ¡éªŒå‡½æ•°</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> authenticate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">req</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> authHeader</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> req.headers.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;authorization&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">authHeader </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> !</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">authHeader.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">startsWith</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Bearer &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> token</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> authHeader.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">split</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot; &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> jwt.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">verify</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(token, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">SECRET</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// è¿”å›ç”¨æˆ·ä¿¡æ¯</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (err) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> GET</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">req</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> user</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> authenticate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(req);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">user) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Response</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">stringify</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ error: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;æœªæˆæƒ&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }), { status: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">401</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">rows</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pool.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">query</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;SELECT * FROM users&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Response</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">stringify</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(rows), {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    status: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">200</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    headers: { </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Content-Type&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;application/json&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>ç°åœ¨ï¼Œè®¿é—® <code>/api/users</code> å¿…é¡»å¸¦ä¸Šæ­£ç¡®çš„ JWTï¼š</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>Authorization: Bearer &lt;token&gt;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div>`,27))])}const C=n(E,[["render",d]]);export{b as __pageData,C as default};
