import{_ as n,C as t,c as l,o as e,j as a,G as p,aQ as h,a as r}from"./chunks/framework.DEi4YP2n.js";const u=JSON.parse('{"title":"MySQL 事务","description":"","frontmatter":{},"headers":[],"relativePath":"column/Node/MySQL/事务理解.md","filePath":"column/Node/MySQL/事务理解.md","lastUpdated":1762823005000}'),d={name:"column/Node/MySQL/事务理解.md"};function k(o,s,c,g,E,b){const i=t("ArticleMetadata");return e(),l("div",null,[s[0]||(s[0]=a("h1",{id:"mysql-事务",tabindex:"-1"},[r("MySQL 事务 "),a("a",{class:"header-anchor",href:"#mysql-事务","aria-label":'Permalink to "MySQL 事务"'},"​")],-1)),p(i),s[1]||(s[1]=h(`<h2 id="一、什么是事务-transaction" tabindex="-1">一、什么是事务（Transaction） <a class="header-anchor" href="#一、什么是事务-transaction" aria-label="Permalink to &quot;一、什么是事务（Transaction）&quot;">​</a></h2><p>在 <code>MySQL</code> 中，<strong>事务（Transaction）<strong>是指一组操作，要么全部成功执行，要么全部失败回滚。事务可以保证数据库在出现异常（断电、错误、崩溃）时仍然保持</strong>数据一致性（Consistency）</strong>。</p><p>简单一句话：</p><blockquote><p><strong>事务 = 一组不可分割的数据库操作。</strong></p></blockquote><h2 id="二、事务的四大特性-acid-原则" tabindex="-1">二、事务的四大特性（ACID 原则） <a class="header-anchor" href="#二、事务的四大特性-acid-原则" aria-label="Permalink to &quot;二、事务的四大特性（ACID 原则）&quot;">​</a></h2><p>事务的核心特性通常被称为 <strong>ACID</strong>：</p><table tabindex="0"><thead><tr><th>特性</th><th>名称</th><th>含义</th></tr></thead><tbody><tr><td>A</td><td><strong>Atomicity（原子性）</strong></td><td>事务中的所有操作要么全部执行成功，要么全部失败并回滚</td></tr><tr><td>C</td><td><strong>Consistency（一致性）</strong></td><td>事务执行前后，数据必须保持一致（比如转账前后余额总和不变）</td></tr><tr><td>I</td><td><strong>Isolation（隔离性）</strong></td><td>并发执行的多个事务互不影响</td></tr><tr><td>D</td><td><strong>Durability（持久性）</strong></td><td>一旦事务提交，其结果会永久保存到数据库中，即使系统崩溃也不会丢失</td></tr></tbody></table><h2 id="三、事务的基本操作" tabindex="-1">三、事务的基本操作 <a class="header-anchor" href="#三、事务的基本操作" aria-label="Permalink to &quot;三、事务的基本操作&quot;">​</a></h2><p>MySQL 默认使用 InnoDB 存储引擎，它是支持事务的。</p><p>常见的事务语句如下：</p><div class="language-sql vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 开启事务</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">START TRANSACTION</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 或者简写</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">BEGIN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 执行多条语句</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">UPDATE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> accounts </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SET</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> balance </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> balance </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 100</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">UPDATE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> accounts </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SET</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> balance </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> balance </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 100</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 提交事务（确认执行）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">COMMIT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 如果出现错误则回滚</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ROLLBACK</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h3 id="🌰-示例-模拟转账操作" tabindex="-1">🌰 示例：模拟转账操作 <a class="header-anchor" href="#🌰-示例-模拟转账操作" aria-label="Permalink to &quot;🌰 示例：模拟转账操作&quot;">​</a></h3><p>假设 Alice 向 Bob 转账 100 元，我们需要保证两条 SQL 要么都执行，要么都不执行：</p><div class="language-sql vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">BEGIN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">UPDATE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> accounts </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SET</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> balance </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> balance </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 100</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> WHERE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> name</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;Alice&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">UPDATE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> accounts </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SET</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> balance </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> balance </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 100</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> WHERE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> name</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;Bob&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">COMMIT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>如果在执行第二条语句时出错：</p><div class="language-sql vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ROLLBACK</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>这样数据库就会恢复到事务开始之前的状态，保证<strong>数据一致性</strong>。</p><h2 id="四、事务的自动提交机制" tabindex="-1">四、事务的自动提交机制 <a class="header-anchor" href="#四、事务的自动提交机制" aria-label="Permalink to &quot;四、事务的自动提交机制&quot;">​</a></h2><p>MySQL 默认是开启 <strong>自动提交模式</strong> 的（<code>autocommit = 1</code>）。也就是说，每执行一条语句就会自动提交。</p><p>可以通过以下命令查看或修改：</p><div class="language-sql vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 查看自动提交状态</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> @@autocommit;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 关闭自动提交</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SET</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> autocommit </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 手动提交事务</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">COMMIT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="五、事务隔离级别-isolation-level" tabindex="-1">五、事务隔离级别（Isolation Level） <a class="header-anchor" href="#五、事务隔离级别-isolation-level" aria-label="Permalink to &quot;五、事务隔离级别（Isolation Level）&quot;">​</a></h2><p>当多个事务同时执行时，可能会出现一些并发问题，例如：</p><table tabindex="0"><thead><tr><th>问题类型</th><th>说明</th></tr></thead><tbody><tr><td><strong>脏读（Dirty Read）</strong></td><td>事务读取了另一个事务尚未提交的数据</td></tr><tr><td><strong>不可重复读（Non-repeatable Read）</strong></td><td>事务多次读取同一条记录，结果不一致</td></tr><tr><td><strong>幻读（Phantom Read）</strong></td><td>事务多次查询发现数据条数发生了变化</td></tr></tbody></table><p>MySQL 提供了 4 种隔离级别来解决这些问题：</p><table tabindex="0"><thead><tr><th>隔离级别</th><th>描述</th><th>能防止的问题</th></tr></thead><tbody><tr><td><strong>READ UNCOMMITTED</strong></td><td>可以读取未提交的数据</td><td>无法防止任何问题</td></tr><tr><td><strong>READ COMMITTED</strong></td><td>只能读取已提交的数据</td><td>防止脏读</td></tr><tr><td><strong>REPEATABLE READ</strong> <em>(默认)</em></td><td>多次读取结果一致</td><td>防止脏读、不可重复读</td></tr><tr><td><strong>SERIALIZABLE</strong></td><td>串行执行事务，性能最低</td><td>防止所有问题</td></tr></tbody></table><p>设置隔离级别：</p><div class="language-sql vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SET</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> SESSION</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> TRANSACTION</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ISOLATION</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> LEVEL</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> REPEATABLE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> READ</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h2 id="六、事务日志-redo-log-undo-log" tabindex="-1">六、事务日志（Redo Log &amp; Undo Log） <a class="header-anchor" href="#六、事务日志-redo-log-undo-log" aria-label="Permalink to &quot;六、事务日志（Redo Log &amp; Undo Log）&quot;">​</a></h2><p>InnoDB 为了保证 ACID 特性，底层依赖两种日志：</p><table tabindex="0"><thead><tr><th>日志类型</th><th>作用</th></tr></thead><tbody><tr><td><strong>Redo Log</strong></td><td>保证“持久性”，记录已提交事务的修改，用于崩溃恢复</td></tr><tr><td><strong>Undo Log</strong></td><td>保证“原子性”和“回滚”，记录事务未提交前的旧值</td></tr></tbody></table><p>当事务提交后：</p><ul><li>Redo Log 会将修改刷入磁盘；</li><li>Undo Log 会被清理；</li><li>系统崩溃时可用 Redo Log 恢复。</li></ul><h2 id="七、事务在应用中的最佳实践" tabindex="-1">七、事务在应用中的最佳实践 <a class="header-anchor" href="#七、事务在应用中的最佳实践" aria-label="Permalink to &quot;七、事务在应用中的最佳实践&quot;">​</a></h2><p>✅ <strong>1. 只在必要的地方使用事务</strong> 事务会加锁、影响性能，不要滥用。</p><p>✅ <strong>2. 控制事务范围</strong> 避免在事务中执行长时间操作（如网络请求），防止锁等待或死锁。</p><p>✅ <strong>3. 使用合适的隔离级别</strong> 业务允许的情况下，优先使用 <code>READ COMMITTED</code> 或默认的 <code>REPEATABLE READ</code>，性能更优。</p><p>✅ <strong>4. 保持一致的事务管理方式</strong> 应用层（如 Node.js、Java、Python）也应与数据库层事务逻辑保持一致。</p>`,38))])}const A=n(d,[["render",k]]);export{u as __pageData,A as default};
