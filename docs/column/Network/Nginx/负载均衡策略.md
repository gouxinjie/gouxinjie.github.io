# **Nginx è´Ÿè½½å‡è¡¡ç­–ç•¥**

`Nginx `ä½œä¸ºé«˜æ€§èƒ½çš„åå‘ä»£ç†æœåŠ¡å™¨ï¼Œæä¾›äº†å¤šç§è´Ÿè½½å‡è¡¡ç®—æ³•ï¼Œèƒ½å¤Ÿæœ‰æ•ˆåˆ†é…å®¢æˆ·ç«¯è¯·æ±‚åˆ°åç«¯æœåŠ¡å™¨ç¾¤é›†ã€‚

## **1. åŸºç¡€è´Ÿè½½å‡è¡¡é…ç½®**

```nginx
http {
    upstream backend {
        # å®šä¹‰åç«¯æœåŠ¡å™¨ç¾¤
        server 10.0.0.1:80;
        server 10.0.0.2:80;
        server 10.0.0.3:80;
    }

    server {
        listen 80;

        location / {
            proxy_pass http://backend;
        }
    }
}
```

## **2. æ ¸å¿ƒè´Ÿè½½å‡è¡¡ç­–ç•¥**

### **2.1 è½®è¯¢ï¼ˆRound Robinï¼‰**

**é»˜è®¤ç­–ç•¥**ï¼ŒæŒ‰é¡ºåºå‡åŒ€åˆ†é…è¯·æ±‚

```nginx
upstream backend {
    server 10.0.0.1; # æƒé‡é»˜è®¤ä¸º1
    server 10.0.0.2;
}
```

**ç‰¹ç‚¹**ï¼š

- ç®€å•å…¬å¹³çš„è¯·æ±‚åˆ†é…
- ä¸è€ƒè™‘æœåŠ¡å™¨è´Ÿè½½æƒ…å†µ
- é€‚åˆæœåŠ¡å™¨æ€§èƒ½ç›¸è¿‘çš„åœºæ™¯

### **2.2 åŠ æƒè½®è¯¢ï¼ˆWeighted Round Robinï¼‰**

æ ¹æ®æœåŠ¡å™¨æ€§èƒ½åˆ†é…ä¸åŒæƒé‡

```nginx
upstream backend {
    server 10.0.0.1 weight=3; # å¤„ç†3å€è¯·æ±‚
    server 10.0.0.2 weight=1;
}
```

**ç‰¹ç‚¹**ï¼š

- é«˜æ€§èƒ½æœåŠ¡å™¨å¯æ‰¿æ‹…æ›´å¤šæµé‡
- æƒé‡æ¯”ä¸ºè¯·æ±‚åˆ†é…æ¯”ä¾‹ï¼ˆå¦‚ 3:1ï¼‰
- éœ€æ‰‹åŠ¨é…ç½®æƒé‡å€¼

### **2.3 æœ€å°‘è¿æ¥ï¼ˆLeast Connectionsï¼‰**

ä¼˜å…ˆé€‰æ‹©å½“å‰è¿æ¥æ•°æœ€å°‘çš„æœåŠ¡å™¨

```nginx
upstream backend {
    least_conn;
    server 10.0.0.1;
    server 10.0.0.2;
}
```

**ç‰¹ç‚¹**ï¼š

- åŠ¨æ€å¹³è¡¡æœåŠ¡å™¨è´Ÿè½½
- é€‚åˆé•¿è¿æ¥åœºæ™¯ï¼ˆå¦‚ WebSocketï¼‰
- éœ€è¦ Nginx å®æ—¶ç›‘æ§è¿æ¥æ•°

### **2.4 IP å“ˆå¸Œï¼ˆIP Hashï¼‰**

åŸºäºå®¢æˆ·ç«¯ IP å›ºå®šåˆ†é…æœåŠ¡å™¨

```nginx
upstream backend {
    ip_hash;
    server 10.0.0.1;
    server 10.0.0.2;
}
```

**ç‰¹ç‚¹**ï¼š

- ä¿æŒä¼šè¯ä¸€è‡´æ€§ï¼ˆSession Persistenceï¼‰
- è§£å†³åˆ†å¸ƒå¼ä¼šè¯é—®é¢˜
- å¯èƒ½å¯¼è‡´è´Ÿè½½ä¸å‡

### **2.5 å“åº”æ—¶é—´ä¼˜å…ˆï¼ˆLeast Timeï¼‰**

Nginx Plus ä¸“å±ï¼ŒåŸºäºå“åº”æ—¶é—´å’Œè¿æ¥æ•°

```nginx
upstream backend {
    least_time header; # æˆ–last_byte
    server 10.0.0.1;
    server 10.0.0.2;
}
```

**ç‰¹ç‚¹**ï¼š

- å•†ä¸šç‰ˆ Nginx ç‹¬æœ‰åŠŸèƒ½
- é€‰æ‹©æœ€å¿«å“åº”çš„æœåŠ¡å™¨
- éœ€è¦æœåŠ¡å™¨æ€§èƒ½ç›‘æ§

### **2.6 éšæœºè´Ÿè½½å‡è¡¡ï¼ˆRandomï¼‰**

éšæœºé€‰æ‹©åç«¯æœåŠ¡å™¨

```nginx
upstream backend {
    random;
    server 10.0.0.1;
    server 10.0.0.2;
}
```

**å˜ç§**ï¼šå¸¦æƒé‡çš„éšæœº

```nginx
upstream backend {
    random two; # éšæœºé€‰2å°åæ ¹æ®æƒé‡é€‰æ‹©
    server 10.0.0.1 weight=3;
    server 10.0.0.2 weight=1;
}
```

## **3. é«˜çº§é…ç½®æŠ€å·§**

### **3.1 å¥åº·æ£€æŸ¥**

```nginx
upstream backend {
    server 10.0.0.1 max_fails=3 fail_timeout=30s;
    server 10.0.0.2;
}
```

- `max_fails`ï¼šå…è®¸å¤±è´¥æ¬¡æ•°
- `fail_timeout`ï¼šæ•…éšœæœåŠ¡å™¨æš‚åœæœåŠ¡æ—¶é—´

### **3.2 å¤‡ä»½æœåŠ¡å™¨**

```nginx
upstream backend {
    server 10.0.0.1;
    server 10.0.0.2 backup; # ä»…å½“ä¸»æœåŠ¡å™¨ä¸å¯ç”¨æ—¶å¯ç”¨
}
```

### **3.3 é•¿è¿æ¥ä¼˜åŒ–**

```nginx
upstream backend {
    server 10.0.0.1;
    keepalive 32; # ä¿æŒçš„è¿æ¥æ± å¤§å°
}
```

### **3.4 åˆ†ç‰‡è´Ÿè½½å‡è¡¡**

```nginx
# æŒ‰URLè·¯å¾„åˆ†é…åˆ°ä¸åŒé›†ç¾¤
location /video/ {
    proxy_pass http://video_backend;
}

location /api/ {
    proxy_pass http://api_backend;
}
```

## **4. ç­–ç•¥é€‰æ‹©å†³ç­–æŒ‡å—**

| åœºæ™¯           | æ¨èç­–ç•¥      | åŸå›          |
| -------------- | ------------- | ------------ |
| å¸¸è§„ Web åº”ç”¨  | åŠ æƒè½®è¯¢      | ç®€å•é«˜æ•ˆ     |
| ä¼šè¯ä¾èµ–å‹åº”ç”¨ | IP å“ˆå¸Œ       | ä¿æŒä¼šè¯ä¸€è‡´ |
| é•¿è¿æ¥æœåŠ¡     | æœ€å°‘è¿æ¥      | å¹³è¡¡æŒä¹…è¿æ¥ |
| é™æ€èµ„æºåˆ†å‘   | è½®è¯¢          | æ— çŠ¶æ€è¯·æ±‚   |
| é«˜å¯ç”¨é›†ç¾¤     | å¥åº·æ£€æŸ¥+å¤‡ä»½ | æ•…éšœè‡ªåŠ¨è½¬ç§» |
| å•†ä¸šç‰ˆç¯å¢ƒ     | å“åº”æ—¶é—´ä¼˜å…ˆ  | æœ€ä¼˜æ€§èƒ½     |

## **5. å¯è§†åŒ–ç­–ç•¥å¯¹æ¯”**

![è´Ÿè½½å‡è¡¡ç­–ç•¥å¯¹æ¯”](../images/nginx-7.png)

## **6. æ€§èƒ½ç›‘æ§å»ºè®®**

1. **Nginx çŠ¶æ€æ¨¡å—**ï¼š

   ```nginx
   location /nginx_status {
       stub_status on;
       allow 10.0.0.0/24;
       deny all;
   }
   ```

2. **å…³é”®æŒ‡æ ‡**ï¼š

   - è¯·æ±‚å¤„ç†é€Ÿç‡ï¼ˆRequests/secï¼‰
   - åç«¯æœåŠ¡å™¨å“åº”æ—¶é—´
   - æ´»è·ƒè¿æ¥æ•°

3. **æ—¥å¿—åˆ†æ**ï¼š
   ```nginx
   log_format upstream_log '$remote_addr - $upstream_addr - $upstream_response_time';
   ```

## **7. å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ**

**é—®é¢˜ 1ï¼šä¼šè¯ä¸ä¸€è‡´**  
ğŸ‘‰ æ–¹æ¡ˆï¼šä½¿ç”¨`ip_hash`æˆ–å¼•å…¥ Redis é›†ä¸­å¼ä¼šè¯å­˜å‚¨

**é—®é¢˜ 2ï¼šæŸå°æœåŠ¡å™¨è¿‡è½½**  
ğŸ‘‰ æ–¹æ¡ˆï¼šè°ƒæ•´æƒé‡æˆ–å¯ç”¨`least_conn`

**é—®é¢˜ 3ï¼šå¥åº·æ£€æŸ¥ä¸çµæ•**  
ğŸ‘‰ æ–¹æ¡ˆï¼šå‡å°`fail_timeout`å€¼ï¼ˆå¦‚æ”¹ä¸º 10sï¼‰

**é—®é¢˜ 4ï¼šDNS ç¼“å­˜é—®é¢˜**  
ğŸ‘‰ æ–¹æ¡ˆï¼šåœ¨ upstream ä¸­ç›´æ¥ä½¿ç”¨ IP åœ°å€
