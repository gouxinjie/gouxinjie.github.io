# 为什么 CDN 资源不会产生跨域问题

[[toc]]

这是一个非常经典且重要的前端问题。很多人都有一个误解：“CDN 资源不会产生跨域问题”。

实际上，更准确的表述是：**我们通过一些技术手段，让 CDN 资源避免了跨域问题。**

核心原因在于 **CDN 资源的域名通常与主站域名不同，但它们被设计成不会触发浏览器的跨域限制**。下面我们从几个层面来深入解析：

### 1. 什么情况下才会发生“跨域问题”？

首先要明确，跨域问题不是所有请求都会触发。它是**浏览器**出于安全考虑（同源策略）施加的一种限制，只针对某些类型的请求，主要是：

- **AJAX / Fetch 请求**：当你使用 `XMLHttpRequest` 或 `Fetch API` 去请求不同源的资源时。
- **Web 字体**：在 CSS 中通过 `@font-face` 使用不同源的字体文件。
- **Canvas 绘制图片**：在 `canvas` 上使用 `drawImage` 绘制不同源的图片，并尝试调用 `toDataURL()` 或 `getImageData()` 方法。
- **JavaScript 模块**等。

### 2. 常见的 CDN 资源为什么不会触发？

#### a) 脚本资源：`<script src="...">`

- **机制**：HTML 的 `<script>` 标签天生就**允许跨域**。这是历史原因决定的，也是为了允许像使用公共 CDN 上的 jQuery、Vue 等库。
- **背后的逻辑**：浏览器在解析 `<script>` 时，会去下载并执行其中的代码。这些代码在成功加载后，就在当前页面的执行环境中运行。如果这也有跨域限制，那整个互联网的第三方库生态将无法存在。
- **注意**：虽然可以跨域加载，但你可以通过 `crossorigin` 属性来**有选择地**暴露错误信息。这引出了另一个相关概念。

#### b) 图片、CSS、音视频资源：`<img>`, `<link>`, `<video>`

- **机制**：这些资源的加载是 **“嵌入”** 而非“请求数据”。它们被浏览器直接渲染或应用，而不需要通过 JavaScript API 去读取其内容。因此，同源策略不会阻止它们的加载。
- **举例**：你可以随意在页面上插入一个来自其他域名的图片 `<img src="https://cdn.example.com/cat.jpg">`，浏览器会正常加载和显示。

### 3. 如何“主动避免”跨域问题？—— CORS 机制

对于那些**本来会受到同源策略限制**的请求（如 Web 字体、通过 Fetch 请求 CDN 上的 API），CDN 服务商通过配置 **CORS** 来主动解决这个问题。

**CORS 的工作原理：**

当你的网站 `https://www.my-site.com` 试图通过 `Fetch API` 请求 CDN 上的一个资源 `https://cdn.example.com/data.json` 时，浏览器会执行以下步骤：

1.  **发送请求**：浏览器会正常发送请求。
2.  **浏览器检查**：因为这是跨域请求，浏览器会检查响应头中是否包含一个特定的字段：`Access-Control-Allow-Origin`。
3.  **CDN 响应**：配置了 CORS 的 CDN 服务器，会在响应头中包含：
    ```http
    Access-Control-Allow-Origin: https://www.my-site.com
    ```
    或者，如果 CDN 想允许任何网站访问，它会返回：
    ```http
    Access-Control-Allow-Origin: *
    ```
4.  **浏览器放行**：浏览器看到响应头中的 `Access-Control-Allow-Origin` 值包含了你的源站域名（`https://www.my-site.com`）或通配符`*`，就会认为这次跨域请求是安全的，从而将响应数据交给你的前端代码。

**CDN 服务商做了什么？** 他们在 CDN 服务器的配置中，为需要跨域访问的资源（如字体、API 接口等）设置了正确的 `Access-Control-Allow-Origin` 响应头。这就是为什么你可以直接从 CDN 使用 Web 字体，而不会遇到跨域问题。

### 总结

| 资源类型          | 使用的 HTML 标签/API | 为何没有跨域问题                   | 关键原因       |
| :---------------- | :------------------- | :--------------------------------- | :------------- |
| **JavaScript 库** | `<script src="...">` | 历史设计使然，默认允许跨域         | 浏览器特意放行 |
| **图片、CSS**     | `<img>`, `<link>`    | 属于“嵌入”资源，非同源策略限制对象 | 浏览器特意放行 |
| **Web 字体**      | `@font-face` in CSS  | CDN 服务器配置了**CORS**响应头     | 主动授权       |
| **API 数据**      | `Fetch` / `AJAX`     | CDN 服务器配置了**CORS**响应头     | 主动授权       |

所以，结论是：

1.  **对于默认就允许跨域的标签（如`<script>`、`<img>`），CDN 资源天然无跨域问题。**
2.  **对于默认不允许跨域的请求（如字体、Fetch），CDN 服务商通过正确配置 CORS 响应头，主动告诉浏览器“我允许你跨域访问我”，从而避免了跨域问题。**

这使得 CDN 在作为资源托管和分发的角色时，能够无缝地与任何站点的前端代码协同工作。
