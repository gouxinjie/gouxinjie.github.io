# HTML + JS å®ç°ä¸‹æ‹‰åˆ·æ–°æ•ˆæœ

[[toc]]

## ä¸€ã€å®ç°ç›®æ ‡

- âœ… æ”¯æŒâ€œä¸‹æ‹‰åˆ·æ–°â€äº¤äº’ï¼ˆä»…åœ¨é¡¶éƒ¨è§¦å‘ï¼‰
- âœ… æ‹–æ‹½æ—¶è·Ÿæ‰‹æ»‘åŠ¨
- âœ… æ¾å¼€åå›å¼¹å¹³æ»‘
- âœ… æ¨¡æ‹Ÿåˆ·æ–°åŠ è½½å¹¶æ¢å¤
- âœ… æ³¨é‡Šæ¸…æ™°ã€å…¼å®¹æ€§å¥½

æœ€ç»ˆæ•ˆæœå¦‚ä¸‹ï¼š

> ğŸ‘‰ ç”¨æˆ·å‘ä¸‹æ‹–æ‹½ â†’ å‡ºç°åˆ·æ–°æŒ‡ç¤ºå™¨ â†’ æ¾æ‰‹è§¦å‘åˆ·æ–° â†’ åŠ¨ç”»å›å¼¹æ¢å¤ã€‚

**å¦‚å›¾æ‰€ç¤ºï¼š**

![ä¸‹æ‹‰åˆ·æ–°æ•ˆæœ](../images/refersh.gif){width=80%}

## äºŒã€æ ¸å¿ƒæ€è·¯

1. **ç›‘å¬è§¦æ‘¸äº‹ä»¶ (`touchstart`, `touchmove`, `touchend`)**

   - è®°å½•æ‰‹æŒ‡èµ·å§‹ä½ç½®ï¼›
   - è®¡ç®—æ‹–æ‹½è·ç¦»ï¼›
   - åœ¨æ»šåŠ¨æ¡ä½äºé¡¶éƒ¨æ—¶æ‰å…è®¸è§¦å‘ä¸‹æ‹‰ã€‚

2. **ç”¨ CSS `transform: translateY()` æ¥ç§»åŠ¨å†…å®¹**

   - ä¸æ”¹å˜å¸ƒå±€ï¼ˆæ€§èƒ½é«˜ï¼Œä¸ä¼šé¢‘ç¹ reflowï¼‰ï¼›
   - æ‹–æ‹½æ—¶å®æ—¶æ›´æ–°ä½ç§»ï¼›
   - å›å¼¹æ—¶æ·»åŠ åŠ¨ç”»è¿‡æ¸¡ã€‚

3. **è®¾ç½®è§¦å‘é˜ˆå€¼**

   - ä¸‹æ‹‰è·ç¦»è¾¾åˆ°ä¸€å®šå€¼ï¼ˆå¦‚ 70pxï¼‰æ‰è§¦å‘åˆ·æ–°ï¼›
   - å¦åˆ™æ¾æ‰‹ç›´æ¥å›å¼¹ã€‚

4. **ä½¿ç”¨ `transition` å®ç°å¹³æ»‘å›å¼¹**

   - æ‹–æ‹½é˜¶æ®µç§»é™¤ transitionï¼›
   - æ¾æ‰‹åå†æ·»åŠ  transitionï¼›
   - åŠ¨ç”»ç»“æŸåæ¸…ç†çŠ¶æ€ã€‚

## ä¸‰ã€å®Œæ•´æºç 

```html
<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ä¸‹æ‹‰åˆ·æ–°æ•ˆæœ - åŸç”Ÿå®ç°</title>
    <style>
      /* === åŸºç¡€æ ·å¼ === */
      html,
      body {
        margin: 0;
        height: 100%;
        overscroll-behavior-y: contain; /* é˜»æ­¢æµè§ˆå™¨é»˜è®¤å›å¼¹åˆ·æ–° */
        -webkit-user-select: none; /* ç¦æ­¢é€‰ä¸­æ–‡æœ¬ */
      }

      .app {
        height: 100%;
        display: flex;
        flex-direction: column;
      }

      /* === é¡¶éƒ¨åˆ·æ–°æŒ‡ç¤ºå™¨ === */
      .ptr {
        height: 0; /* åˆå§‹é«˜åº¦ä¸º0 */
        display: flex;
        align-items: flex-end;
        justify-content: center;
        overflow: visible;
      }

      .indicator {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: 3px solid rgba(0, 0, 0, 0.15);
        border-top-color: #007bff;
        transform-origin: center;
        opacity: 0;
      }

      /* ä¸‹æ‹‰ä¸­æ˜¾ç¤ºæŒ‡ç¤ºå™¨ */
      .ptr.pull .indicator {
        opacity: 1;
      }

      /* åˆ·æ–°ä¸­æ—‹è½¬åŠ¨ç”» */
      .ptr.refreshing .indicator {
        animation: spin 1s linear infinite;
        opacity: 1;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* === ä¸»å†…å®¹åŒº === */
      .content {
        flex: 1;
        overflow: auto;
        -webkit-overflow-scrolling: touch;
        background: #fafafa;
        padding: 16px;
        transform: translateY(0);
      }

      /* æ·»åŠ è¿‡æ¸¡åŠ¨ç”»çš„ç±»ï¼ˆæ¾æ‰‹é˜¶æ®µï¼‰ */
      .animate {
        transition: transform 0.35s cubic-bezier(0.22, 1, 0.36, 1);
      }
    </style>
  </head>
  <body>
    <div class="app">
      <div class="ptr" id="ptr">
        <div class="indicator" id="indicator"></div>
      </div>
      <div class="content" id="content">
        <h2>ä¸‹æ‹‰åˆ·æ–°</h2>
        <p>å‘ä¸‹æ‹‰çœ‹çœ‹å§ï½</p>
        <div id="list"></div>
      </div>
    </div>

    <script>
      /**
       * ä¸‹æ‹‰åˆ·æ–°æ ¸å¿ƒé€»è¾‘
       * @author gxj
       */
      (function () {
        // DOM å¼•ç”¨
        const content = document.getElementById("content");
        const ptr = document.getElementById("ptr");
        const indicator = document.getElementById("indicator");
        const list = document.getElementById("list");

        // åˆå§‹åŒ–åˆ—è¡¨å†…å®¹
        for (let i = 1; i <= 30; i++) {
          const p = document.createElement("p");
          p.textContent = "åˆ—è¡¨é¡¹ " + i;
          list.appendChild(p);
        }

        // é…ç½®å‚æ•°
        const THRESHOLD = 70; // è§¦å‘åˆ·æ–°é˜ˆå€¼
        const MAX_PULL = 150; // æœ€å¤§å¯ä¸‹æ‹‰è·ç¦»
        let startY = 0; // æ‰‹æŒ‡èµ·å§‹ä½ç½®
        let pulling = false; // æ˜¯å¦æ­£åœ¨ä¸‹æ‹‰
        let canPull = false; // æ˜¯å¦å…è®¸ä¸‹æ‹‰
        let refreshing = false; // æ˜¯å¦æ­£åœ¨åˆ·æ–°

        /** touchstart: åˆ¤æ–­æ˜¯å¦å¯ä»¥ä¸‹æ‹‰ **/
        content.addEventListener(
          "touchstart",
          (e) => {
            if (refreshing) return;
            if (content.scrollTop <= 0) {
              canPull = true;
              startY = e.touches[0].clientY;
              content.classList.remove("animate"); // å»é™¤è¿‡æ¸¡ï¼Œä¿æŒè·Ÿæ‰‹
            } else {
              canPull = false;
            }
          },
          { passive: true }
        );

        /** touchmove: è®¡ç®—ä¸‹æ‹‰è·ç¦»å¹¶å®æ—¶æ›´æ–°UI **/
        content.addEventListener(
          "touchmove",
          (e) => {
            if (!canPull || refreshing) return;
            const delta = e.touches[0].clientY - startY;
            if (delta > 0) {
              e.preventDefault(); // é˜»æ­¢é»˜è®¤æ»šåŠ¨
              pulling = true;
              // æ·»åŠ é˜»å°¼æ•ˆæœï¼Œé˜²æ­¢æ‹‰å¾—å¤ªè¿œ
              const offset = Math.min(delta * 0.5, MAX_PULL);
              // åŒæ­¥ç§»åŠ¨å†…å®¹å’ŒæŒ‡ç¤ºå™¨
              ptr.style.height = offset + "px";
              content.style.transform = `translateY(${offset}px)`;
              ptr.classList.toggle("pull", offset > 0);
              // æ—‹è½¬æŒ‡ç¤ºå™¨ï¼Œä½œä¸ºâ€œä¸‹æ‹‰è¿›åº¦â€
              indicator.style.transform = `rotate(${(offset / THRESHOLD) * 180}deg)`;
            }
          },
          { passive: false }
        );

        /** touchend: æ¾æ‰‹åå†³å®šæ˜¯å¦è§¦å‘åˆ·æ–° **/
        content.addEventListener("touchend", async () => {
          if (!pulling) return;
          pulling = false;
          content.classList.add("animate"); // âœ… æ·»åŠ å›å¼¹åŠ¨ç”»
          const h = parseFloat(ptr.style.height || 0);

          if (h >= THRESHOLD) {
            // === è§¦å‘åˆ·æ–° ===
            refreshing = true;
            ptr.classList.add("refreshing");
            ptr.style.height = THRESHOLD + "px";
            content.style.transform = `translateY(${THRESHOLD}px)`;

            await onRefresh(); // æ‰§è¡Œå¼‚æ­¥åˆ·æ–°é€»è¾‘

            // === åˆ·æ–°å®Œæˆï¼Œå¹³æ»‘å›å¼¹ ===
            ptr.classList.remove("refreshing");
            ptr.style.height = "0px";
            content.style.transform = "translateY(0)";
            // ç­‰å¾…åŠ¨ç”»å®Œæˆåè§£é™¤åŠ¨ç”»ç±»
            setTimeout(() => {
              refreshing = false;
              content.classList.remove("animate");
            }, 350);
          } else {
            // === æœªè¶…è¿‡é˜ˆå€¼ï¼Œç›´æ¥å›å¼¹ ===
            ptr.style.height = "0px";
            content.style.transform = "translateY(0)";
            setTimeout(() => content.classList.remove("animate"), 350);
          }
        });

        /**
         * æ¨¡æ‹Ÿå¼‚æ­¥åˆ·æ–°å‡½æ•°
         * çœŸå®åœºæ™¯ä¸­å¯åœ¨æ­¤å‘èµ·æ¥å£è¯·æ±‚
         */
        function onRefresh() {
          return new Promise((resolve) => {
            setTimeout(() => {
              const p = document.createElement("p");
              p.textContent = "åˆ·æ–°æ—¶é—´ï¼š" + new Date().toLocaleTimeString();
              list.prepend(p);
              resolve();
            }, 1200);
          });
        }
      })();
    </script>
  </body>
</html>
```

## å››ã€æ ¸å¿ƒé€»è¾‘è¯¦è§£

| æ­¥éª¤        | äº‹ä»¶             | å…³é”®ç‚¹                  | è¯´æ˜                                         |
| ----------- | ---------------- | ----------------------- | -------------------------------------------- |
| 1ï¸âƒ£ è§¦æ‘¸å¼€å§‹ | `touchstart`     | åˆ¤æ–­æ˜¯å¦æ»šåŠ¨åˆ°é¡¶éƒ¨      | åªæœ‰å½“ `scrollTop === 0` æ‰å…è®¸è§¦å‘ä¸‹æ‹‰      |
| 2ï¸âƒ£ æ‹–æ‹½ä¸­   | `touchmove`      | å®æ—¶è®¡ç®—ä¸‹æ‹‰è·ç¦»        | ç”¨ `translateY` å®ç°â€œè·Ÿæ‰‹â€æ•ˆæœï¼Œé˜»å°¼ç³»æ•° 0.5 |
| 3ï¸âƒ£ æ¾æ‰‹     | `touchend`       | åˆ¤æ–­é˜ˆå€¼                | è¶…è¿‡é˜ˆå€¼è§¦å‘åˆ·æ–°ï¼Œå¦åˆ™å›å¼¹                   |
| 4ï¸âƒ£ åˆ·æ–°ä¸­   | Promise æ¨¡æ‹Ÿè¯·æ±‚ | æ·»åŠ  `.refreshing` åŠ¨ç”» | æŒ‡ç¤ºå™¨æ—‹è½¬ã€å†…å®¹ä¿æŒä¸‹ç§»                     |
| 5ï¸âƒ£ åˆ·æ–°å®Œæˆ | åŠ¨ç”»å›å¼¹         | ç§»é™¤ `.animate`         | å¹³æ»‘å›åˆ°åˆå§‹ä½ç½®                             |

## äº”ã€è®©å›å¼¹æ›´æµç•…çš„å…³é”®

1. **æ‹–æ‹½é˜¶æ®µç¦ç”¨ transition**

   ```js
   content.classList.remove("animate");
   ```

   ğŸ‘‰ é¿å…æ‰‹æŒ‡æ‹–åŠ¨æ—¶åŠ¨ç”»æ»åï¼Œä¿è¯â€œè·Ÿæ‰‹â€ã€‚

2. **æ¾æ‰‹é˜¶æ®µå†æ·»åŠ  transition**

   ```js
   content.classList.add("animate");
   ```

   ğŸ‘‰ è®©æ¾å¼€åçš„å›å¼¹è‡ªç„¶ã€å¹³æ»‘ã€‚

3. **ä½¿ç”¨åˆé€‚çš„ç¼“åŠ¨æ›²çº¿**

   ```css
   transition: transform 0.35s cubic-bezier(0.22, 1, 0.36, 1);
   ```

   ğŸ‘‰ æ¨¡æ‹ŸåŸç”Ÿ iOS å¼¹æ€§æ•ˆæœï¼ˆæ¯”é»˜è®¤ `ease` æ›´é¡ºæ»‘ï¼‰ã€‚

4. **åœ¨åŠ¨ç”»ç»“æŸåæ¸…ç†çŠ¶æ€**

   ```js
   setTimeout(() => content.classList.remove("animate"), 350);
   ```

   ğŸ‘‰ ä¿è¯ä¸‹æ¬¡ä¸‹æ‹‰æ—¶ä¾æ—§æµç•…ã€‚

ğŸ“˜ **å»¶ä¼¸é˜…è¯»**

- [MDN - Touch Events](https://developer.mozilla.org/zh-CN/docs/Web/API/Touch_events)
- [overscroll-behavior å±æ€§](https://developer.mozilla.org/zh-CN/docs/Web/CSS/overscroll-behavior)
