# Vue 依赖注入(provide/inject)：组件跨层级通信的优雅方案

## 一、什么是 provide/inject？

`provide/inject 是 Vue` 提供的一种组件通信方式，允许祖先组件向其所有子孙组件"注入"依赖，无论组件层次有多深。这是 `Vue` 官方文档中介绍的解决" `prop` 逐级透传"问题的完美方案。

## 二、基本使用方式

### 1. 提供数据(provide)

```javascript
// 父组件或祖先组件
export default {
  provide: {
    siteName: "Vue官方站点",
    currentUser: {
      name: "张三",
      role: "admin"
    }
  }
};
```

### 2. 注入数据(inject)

```javascript
// 子孙组件
export default {
  inject: ["siteName", "currentUser"],
  created() {
    console.log(this.siteName); // "Vue官方站点"
    console.log(this.currentUser.name); // "张三"
  }
};
```

## 三、响应式数据传递

默认情况下，`provide/inject` 绑定不是响应式的。要实现响应式，可以使用组合式 API：

```javascript
import { provide, ref } from 'vue'

// 提供者组件
setup() {
  const theme = ref('dark')
  provide('theme', theme)

  return {
    theme
  }
}

// 消费者组件
import { inject } from 'vue'

setup() {
  const theme = inject('theme')
  return { theme }
}
```

## 四、实际应用场景

### 1. 主题切换系统

```javascript
// ThemeProvider.vue
import { provide, ref } from 'vue'

export default {
  setup() {
    const theme = ref('light')
    const toggleTheme = () => {
      theme.value = theme.value === 'light' ? 'dark' : 'light'
    }

    provide('theme', theme)
    provide('toggleTheme', toggleTheme)
  }
}

// ThemedButton.vue
import { inject } from 'vue'

export default {
  setup() {
    const theme = inject('theme')
    const toggleTheme = inject('toggleTheme')

    return { theme, toggleTheme }
  }
}
```

### 2. 全局配置共享

```javascript
// App.vue
provide("appConfig", {
  apiBaseUrl: "https://api.example.com",
  maxUploadSize: 1024
});

// 子组件
const config = inject("appConfig");
```

## 五、最佳实践建议

1. **使用 Symbol 作为 key**避免命名冲突

```javascript
// keys.js
export const ThemeSymbol = Symbol();

// 提供者
provide(ThemeSymbol, ref("dark"));

// 消费者
const theme = inject(ThemeSymbol);
```

2. **提供默认值**防止注入失败

```javascript
const value = inject("someKey", "defaultValue");
```

3. **考虑使用类型提示**(TypeScript)

```typescript
interface Theme {
  mode: "light" | "dark";
}

const theme = inject<Theme>("theme");
```

## 六、与其它通信方式对比

| 通信方式       | 适用场景           | 特点                 |
| -------------- | ------------------ | -------------------- |
| Props          | 父子组件直接通信   | 需要逐层传递         |
| Vuex/Pinia     | 复杂全局状态管理   | 适合中大型项目       |
| Event Bus      | 任意组件间通信     | 已不推荐使用         |
| provide/inject | 跨多层组件共享数据 | 精准投递，避免中间层 |