# å¸¸è§é‰´æƒæ–¹æ¡ˆ

[[toc]]

## ä¸€ã€ğŸ”‘ å¸¸è§é‰´æƒæ–¹æ¡ˆ

åœ¨ `Next.js (App Router) `é‡Œï¼Œå¸¸è§çš„é‰´æƒæ–¹å¼æœ‰ä¸‰ç±»ï¼š

### 1. **åŸºäº Cookie / Sessionï¼ˆæ¨èç”¨äºç½‘ç«™ç™»å½•ï¼‰**

- ç”¨æˆ·ç™»å½•æ—¶ï¼ŒéªŒè¯ç”¨æˆ·å/å¯†ç  â†’ ç”Ÿæˆ Sessionï¼Œå†™åˆ°æ•°æ®åº“ï¼ˆæˆ– Redisï¼‰ã€‚
- é€šè¿‡ `Set-Cookie` è¿”å›ç»™æµè§ˆå™¨ã€‚
- åç»­è¯·æ±‚æ—¶ï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨å¸¦ä¸Š Cookieï¼ŒAPI è·¯ç”±é‡Œè§£æ Cookie å¹¶æ ¡éªŒã€‚

ğŸ‘‰ å·¥å…·ï¼š

- [`next-auth`](https://next-auth.js.org/)ï¼ˆæœ€å¸¸è§ï¼Œæ”¯æŒ OAuthã€é‚®ç®±ç™»å½•ã€JWT ç­‰ï¼‰
- è‡ªå·±å®ç°ï¼ˆç”¨ `cookies()` API + MySQL å­˜ Sessionï¼‰

### 2. åŸºäº JWTï¼ˆé€‚åˆå‰åç«¯åˆ†ç¦» / ç§»åŠ¨ç«¯ / API æœåŠ¡ï¼‰

- ç™»å½•æ—¶ç”Ÿæˆ **JWT Token**ï¼ˆåŒ…å«ç”¨æˆ· ID ç­‰ä¿¡æ¯ï¼Œç­¾åä¿è¯ä¸è¢«ç¯¡æ”¹ï¼‰ã€‚
- å®¢æˆ·ç«¯ä¿å­˜åˆ° `localStorage` æˆ– `httpOnly Cookie`ã€‚
- æ¯æ¬¡è¯·æ±‚æ—¶åœ¨ `Authorization` å¤´é‡Œå¸¦ä¸Šï¼š

  ```
  Authorization: Bearer <token>
  ```

- API è·¯ç”±é‡Œæ ¡éªŒ Token æ˜¯å¦æœ‰æ•ˆã€‚

ğŸ‘‰ å·¥å…·ï¼š

- `jsonwebtoken` åº“
- å¯ä»¥é…åˆ `middleware.js` åœ¨å…¨å±€åšä¿æŠ¤

### 3. **API Keyï¼ˆé€‚åˆæœåŠ¡ç«¯ API è°ƒç”¨ï¼Œæ¯”å¦‚ AI æ¨¡å‹æ¥å£ï¼‰**

- ç»™æ¯ä¸ªç”¨æˆ·åˆ†é…ä¸€ä¸ª API Keyï¼ˆå­˜ MySQLï¼‰ã€‚
- å®¢æˆ·ç«¯è¯·æ±‚æ—¶å¸¦ä¸Šï¼š

  ```
  Authorization: Bearer <API_KEY>
  ```

- åç«¯æ ¡éªŒ Key æ˜¯å¦å­˜åœ¨ & æƒé™æ˜¯å¦è¶³å¤Ÿã€‚

## äºŒã€åŸºäºJWTè®¤è¯çš„æ¡ˆä¾‹

ä¸‹é¢æ˜¯ä¸€ä¸ªåœ¨ `Next.js`é¡¹ç›®ä¸­åŸºäº `JWT` ä¿æŠ¤ `/api/users` æ¥å£çš„æ¡ˆä¾‹ã€‚

### 1. å®‰è£…ä¾èµ–

```bash
pnpm install jsonwebtoken bcryptjs
```

### 2. æ·»åŠ ç™»å½•æ¥å£ `app/api/auth/login/route.js`

```js
import pool from "@/lib/db";
import jwt from "jsonwebtoken";
import bcrypt from "bcryptjs";

const SECRET = process.env.JWT_SECRET || "mysecret"; // åº”æ”¾åˆ° .env æ–‡ä»¶

export async function POST(req) {
  try {
    const { email, password } = await req.json();
    const [rows] = await pool.query("SELECT * FROM users WHERE email = ?", [email]);

    if (rows.length === 0) {
      return new Response(JSON.stringify({ error: "ç”¨æˆ·ä¸å­˜åœ¨" }), { status: 401 });
    }

    const user = rows[0];
    const valid = await bcrypt.compare(password, user.password);
    if (!valid) {
      return new Response(JSON.stringify({ error: "å¯†ç é”™è¯¯" }), { status: 401 });
    }

    // ç”Ÿæˆ JWT
    const token = jwt.sign({ id: user.id, email: user.email }, SECRET, { expiresIn: "1h" });

    return new Response(JSON.stringify({ token }), {
      status: 200,
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    return new Response(JSON.stringify({ error: error.message }), { status: 500 });
  }
}
```

è°ƒç”¨ä¹‹åï¼Œè¿”å›çš„ `token` æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œç±»ä¼¼ `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MSwiZW1haWwiOiJ0ZXN0QHRlc3QuY29tIiwiaWF0IjoxNzI2NjY3NjQyLCJleHAiOjE3MjY2NzE2NDN9.1234567890abcdef1234567890abcdef`ã€‚

**å¦‚å›¾æ‰€ç¤ºï¼š**

![auth-1.png](../images/auth-1.png)

### 3. ä¿æŠ¤ `/api/users`

åœ¨ `app/api/users/route.js` é‡ŒåŠ  **Token æ ¡éªŒ**ï¼š

```js
import pool from "@/lib/db";
import jwt from "jsonwebtoken";

const SECRET = process.env.JWT_SECRET || "mysecret";

// æ ¡éªŒå‡½æ•°
async function authenticate(req) {
  const authHeader = req.headers.get("authorization");
  if (!authHeader || !authHeader.startsWith("Bearer ")) return null;

  const token = authHeader.split(" ")[1];
  try {
    return jwt.verify(token, SECRET); // è¿”å›ç”¨æˆ·ä¿¡æ¯
  } catch (err) {
    return null;
  }
}

export async function GET(req) {
  const user = await authenticate(req);
  if (!user) {
    return new Response(JSON.stringify({ error: "æœªæˆæƒ" }), { status: 401 });
  }

  const [rows] = await pool.query("SELECT * FROM users");
  return new Response(JSON.stringify(rows), {
    status: 200,
    headers: { "Content-Type": "application/json" }
  });
}
```

ç°åœ¨ï¼Œè®¿é—® `/api/users` å¿…é¡»å¸¦ä¸Šæ­£ç¡®çš„ JWTï¼š

```
Authorization: Bearer <token>
```
