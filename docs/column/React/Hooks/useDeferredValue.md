# React 18 å¹¶å‘ç‰¹æ€§æ ¸å¿ƒä¹‹ä¸€ï¼šuseDeferredValue

[[toc]]

> React 18 å¼•å…¥çš„å¹¶å‘ç‰¹æ€§è®© UI æ¸²æŸ“æ›´ä¸æ»‘ï¼Œå…¶ä¸­ `useDeferredValue` æ˜¯ä¸€ä¸ªâ€œ**è‡ªåŠ¨å»¶è¿ŸæŸä¸ªå€¼æ›´æ–°**â€çš„ Hookï¼Œå¯ä»¥è®©ä½ çš„ç»„ä»¶åœ¨å¤„ç†å¤§é‡æ•°æ®æˆ–å¤æ‚æ¸²æŸ“æ—¶ä¿æŒæµç•…çš„äº¤äº’ä½“éªŒã€‚

## ä¸€ã€ä¸ºä»€ä¹ˆéœ€è¦ useDeferredValueï¼Ÿ

åœ¨å‰ç«¯å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸é‡åˆ°è¿™æ ·çš„åœºæ™¯ ğŸ‘‡

ç”¨æˆ·è¾“å…¥ä¸€ä¸ªæœç´¢æ¡†ï¼Œè¾“å…¥çš„å€¼ä¼šè§¦å‘ä¸€ä¸ª**æ˜‚è´µçš„è®¡ç®—æˆ–è¿‡æ»¤æ“ä½œ**ï¼š

```jsx
function SearchApp() {
  const [query, setQuery] = useState("");
  const filteredList = heavyFilter(query); // è€—æ—¶æ“ä½œ

  return (
    <>
      <input value={query} onChange={(e) => setQuery(e.target.value)} />
      <List data={filteredList} />
    </>
  );
}
```

ğŸ’¥ é—®é¢˜ï¼š

- æ¯æ¬¡ç”¨æˆ·è¾“å…¥éƒ½ä¼šç«‹å³è§¦å‘è®¡ç®—ï¼›
- `heavyFilter` é€ æˆå¡é¡¿ï¼›
- è¾“å…¥å˜å¾—ä¸æµç•…ã€‚

## äºŒã€useDeferredValue æ˜¯ä»€ä¹ˆï¼Ÿ

> `useDeferredValue` ä¼šè®©ä¸€ä¸ªå€¼çš„æ›´æ–°â€œ**å»¶è¿Ÿç”Ÿæ•ˆ**â€ï¼Œä»è€Œé¿å…è€—æ—¶æ¸²æŸ“é˜»å¡ç”¨æˆ·çš„è¾“å…¥ã€‚

ç®€å•æ¥è¯´ï¼š

> å®ƒæ˜¯ä¸€ä¸ªâ€œè¢«åŠ¨çš„ useTransitionâ€ã€‚

### ğŸ“˜ è¯­æ³•ï¼š

```tsx
const deferredValue = useDeferredValue(value);
```

| å‚æ•°    | ç±»å‹ | è¯´æ˜                 |
| ------- | ---- | -------------------- |
| `value` | any  | åŸå§‹å€¼               |
| è¿”å›å€¼  | any  | React å»¶è¿Ÿæ›´æ–°åçš„å€¼ |

## ä¸‰ã€åŸºç¡€ç¤ºä¾‹ï¼šè¾“å…¥é˜²å¡é¡¿

```jsx
import React, { useState, useDeferredValue } from "react";

function SearchApp() {
  const [query, setQuery] = useState("");
  const deferredQuery = useDeferredValue(query); // å»¶è¿Ÿ query æ›´æ–°

  const list = heavyFilter(deferredQuery);

  return (
    <div>
      <input value={query} onChange={(e) => setQuery(e.target.value)} />
      {query !== deferredQuery && <p>åŠ è½½ä¸­...</p>}
      <List data={list} />
    </div>
  );
}
```

âœ… æ•ˆæœï¼š

- ç”¨æˆ·è¾“å…¥ç«‹å³æ›´æ–° `query`ï¼›
- `deferredQuery` ä¼šç¨å¾®å»¶è¿Ÿï¼›
- `heavyFilter()` åœ¨æµè§ˆå™¨ç©ºé—²æ—¶æ‰§è¡Œï¼›
- è¾“å…¥ä¸å¡é¡¿ã€‚

## å››ã€å·¥ä½œåŸç†

`useDeferredValue` çš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š

> React å°†ä¼ å…¥çš„å€¼è§†ä¸ºâ€œä½ä¼˜å…ˆçº§ä»»åŠ¡â€ï¼Œå½“æµè§ˆå™¨ç©ºé—²æ—¶å†æ›´æ–°è¯¥å€¼ï¼Œä»è€Œé¿å…é˜»å¡æ›´é‡è¦çš„æ¸²æŸ“ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼š

- å½“ `value`ï¼ˆä¾‹å¦‚è¾“å…¥æ¡†å€¼ï¼‰é¢‘ç¹å˜åŒ–æ—¶ï¼Œ
- `deferredValue` ä¸ä¼šç«‹åˆ»å˜åŒ–ï¼Œ
- React ä¼šç­‰ä¸»çº¿ç¨‹ç©ºé—²åå†æ›´æ–°å®ƒã€‚

è¿™æ ·ï¼Œç”¨æˆ·äº¤äº’å§‹ç»ˆæµç•…ï¼Œè€Œæ˜‚è´µçš„æ›´æ–°å¯ä»¥ç¨åæ‰§è¡Œã€‚

## äº”ã€useTransition vs useDeferredValue å¯¹æ¯”

| ç‰¹æ€§     | useTransition                  | useDeferredValue       |
| -------- | ------------------------------ | ---------------------- |
| è°ƒç”¨æ–¹å¼ | ä¸»åŠ¨åŒ…è£¹æ›´æ–°é€»è¾‘               | è¢«åŠ¨å»¶è¿Ÿå€¼             |
| ä½¿ç”¨åœºæ™¯ | æ§åˆ¶â€œæŸæ®µé€»è¾‘â€å»¶è¿Ÿæ‰§è¡Œ         | æ§åˆ¶â€œæŸä¸ªå€¼â€å»¶è¿Ÿç”Ÿæ•ˆ   |
| è¿”å›å€¼   | `[isPending, startTransition]` | `deferredValue`        |
| æ›´æ–°è§¦å‘ | ç”±ä½ å†³å®šï¼ˆä¸»åŠ¨ï¼‰               | React è‡ªåŠ¨è°ƒåº¦ï¼ˆè¢«åŠ¨ï¼‰ |
| å¸¸ç”¨åœºæ™¯ | æœç´¢ã€åˆ†é¡µã€å¯¼èˆª               | è¾“å…¥æ¡†å€¼ã€é˜²æŠ–æ¸²æŸ“     |

ğŸ’¡ ç®€å•ç†è§£ï¼š

> `useTransition` æ˜¯â€œæ‰‹åŠ¨å»¶è¿Ÿæ›´æ–°â€ï¼Œ `useDeferredValue` æ˜¯â€œè‡ªåŠ¨å»¶è¿ŸæŸä¸ªå€¼â€ã€‚

## å…­ã€å®æˆ˜æ¡ˆä¾‹ï¼šæœç´¢åˆ—è¡¨ä¼˜åŒ–

```jsx
import React, { useState, useDeferredValue } from "react";

const bigList = Array.from({ length: 10000 }, (_, i) => `Item ${i}`);

function Search() {
  const [text, setText] = useState("");
  const deferredText = useDeferredValue(text);

  const filtered = bigList.filter((item) => item.toLowerCase().includes(deferredText.toLowerCase()));

  return (
    <div>
      <input value={text} onChange={(e) => setText(e.target.value)} placeholder="è¾“å…¥æœç´¢å…³é”®å­—" />
      {text !== deferredText && <p>ç­›é€‰ä¸­...</p>}
      <ul>
        {filtered.map((item) => (
          <li key={item}>{item}</li>
        ))}
      </ul>
    </div>
  );
}
```

âœ… ä¼˜ç‚¹ï¼š

- è¾“å…¥æ¡†å“åº”ç«‹åˆ»ï¼›
- æ•°æ®è¿‡æ»¤å»¶åæ‰§è¡Œï¼›
- UI ä¸æ»‘æ— é˜»å¡ã€‚

## ä¸ƒã€æ€§èƒ½åŸç†è§£æï¼ˆç›´è§‚ç†è§£ï¼‰

æƒ³è±¡ä¸¤ä¸ªæ—¶é—´è½´ï¼š

```
ç”¨æˆ·è¾“å…¥ (é«˜ä¼˜å…ˆçº§)  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                   â””â”€â”€â–º é©¬ä¸Šæ‰§è¡Œ
è¿‡æ»¤é€»è¾‘ (ä½ä¼˜å…ˆçº§)   â”€â”€â”€â”€â”€â”€â”€â”€ å»¶åæ‰§è¡Œ
```

- React ä¼šåœ¨æµè§ˆå™¨ç©ºé—²æ—¶æ›´æ–° `deferredValue`ï¼›
- è¿™æ ·ä¸ä¼šå¡ä½ç”¨æˆ·çš„è¾“å…¥ï¼›
- å½“ç©ºé—²åæ‰è§¦å‘è€—æ—¶æ¸²æŸ“ã€‚

è¿™æ­£æ˜¯ **Concurrent Rendering å¹¶å‘æ¨¡å¼** çš„æ ¸å¿ƒèƒ½åŠ›ï¼š ğŸ‘‰ â€œå¯ä¸­æ–­çš„æ¸²æŸ“ + æ™ºèƒ½è°ƒåº¦ä¼˜å…ˆçº§â€ã€‚

## å…«ã€ä¸é˜²æŠ–ï¼ˆdebounceï¼‰çš„åŒºåˆ«

| å¯¹æ¯”é¡¹     | useDeferredValue     | debounce          |
| ---------- | -------------------- | ----------------- |
| åŸç†       | React å†…éƒ¨è°ƒåº¦ä¼˜å…ˆçº§ | å®šæ—¶å™¨å»¶è¿Ÿæ‰§è¡Œ    |
| å“åº”é€Ÿåº¦   | æ›´å¹³æ»‘ï¼ˆReact æ§åˆ¶ï¼‰ | å›ºå®šå»¶è¿Ÿæ—¶é—´      |
| æ¸²æŸ“ä¸€è‡´æ€§ | ç”± React ä¿è¯        | æ‰‹åŠ¨ç®¡ç†æ›´æ–°      |
| SSR æ”¯æŒ   | âœ…                   | âŒ                |
| ç†æƒ³åœºæ™¯   | UI æ¸²æŸ“ä¼˜åŒ–          | API è¯·æ±‚èŠ‚æµ/é˜²æŠ– |

ğŸ‘‰ äºŒè€…ä¸æ˜¯æ›¿ä»£å…³ç³»ï¼Œå¯ä»¥**é…åˆä½¿ç”¨**ï¼š

- ç”¨ `debounce` é™ä½ API è¯·æ±‚é¢‘ç‡ï¼›
- ç”¨ `useDeferredValue` è®© UI æ¸²æŸ“æ›´ä¸æ»‘ã€‚

## ä¹ã€æœ€ä½³å®è·µ

| å»ºè®®                                            | è¯´æ˜                      |
| ----------------------------------------------- | ------------------------- |
| âœ… å»¶è¿Ÿå€¼çš„ä½¿ç”¨è¦æ˜ç¡®                           | é€šå¸¸ç”¨äºè¾“å…¥å€¼ã€è¿‡æ»¤æ¡ä»¶  |
| âœ… ä¸ `Suspense` / `useTransition` æ­é…æ›´ä½³     | æå‡ UI ä½“éªŒ              |
| âœ… ç”¨äºå¤§åˆ—è¡¨ã€å›¾è¡¨ã€å¤æ‚ DOM æ¸²æŸ“              | æ˜¾è‘—ä¼˜åŒ–æ€§èƒ½              |
| âŒ ä¸è¦å»¶è¿Ÿå…³é”®äº¤äº’çš„å€¼ï¼ˆå¦‚è¾“å…¥æ¡†æœ¬èº«çš„ valueï¼‰ | å¦åˆ™ä¼šæ„Ÿè§‰â€œè¾“å…¥å»¶è¿Ÿâ€      |
| âœ… å¯é€šè¿‡æ¯”è¾ƒåŸå§‹å€¼ä¸å»¶è¿Ÿå€¼æ˜¾ç¤ºâ€œåŠ è½½ä¸­â€         | `value !== deferredValue` |
